<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CArgo — Поиск дешевой доставки</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <header class="main-header">
        <div class="theme-switch" onclick="toggleTheme()">
            <i class="fas fa-adjust"></i>
        </div>
        <div class="logo-area">
            <i class="fas fa-paper-plane"></i> CArgo
        </div>
        <p class="tagline">Агрегатор грузоперевозок. Сравниваем цены СДЭК, Boxberry, Почты и других.</p>
    </header>

    <div class="search-container">
        <form method="post" class="search-form" id="searchForm">

            <div class="input-group">
                <label>Откуда</label>
                <select name="from_city" class="input-field" required>
                    <option value="" disabled selected>Город..</option>
                    {% for c in cities %}
                    <option value="{{ c }}" {% if c == from_city %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="input-group">
                <label>Куда</label>
                <select name="to_city" class="input-field" required>
                    <option value="" disabled selected>Город..</option>
                    {% for c in cities %}
                    <option value="{{ c }}" {% if c == to_city %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="input-group" style="max-width: 120px;">
                <label>Вес (кг)</label>
                <input type="number" name="weight" value="{{ weight or 1 }}" min="0.1" max="100" step="0.1" class="input-field" required>
            </div>

            <div class="input-group" style="max-width: 150px;">
                <label>Ценность (₽)</label>
                <input type="number" name="declared" value="{{ declared or 0 }}" min="0" step="100" class="input-field">
            </div>

            <button type="submit" class="search-btn">
                Найти цены
            </button>

            <div class="checkbox-group">
                {% for company in companies %}
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--text-secondary);">
                    <input type="checkbox" name="companies" value="{{ company }}"
                    {% if company in selected_companies or not selected_companies %}checked{% endif %}>
                    {{ company }}
                </label>
                {% endfor %}
            </div>
        </form>
    </div>

    <div class="results-container">
        {% if error %}
        <div class="error-msg">
            <i class="fas fa-exclamation-circle"></i> {{ error }}
        </div>
        {% endif %}

        {% if offers %}
        <div class="results-header">
            <h2>Найдено {{ offers|length }} вариантов</h2>
            <span style="color: var(--text-secondary)">Маршрут: {{ from_city }} &rarr; {{ to_city }}</span>
        </div>

        {% for o in offers %}
        <div class="ticket">
            <div class="ticket-main">
                <div class="company-logo-wrap">
                    {% if o.company == "СДЭК" %} <i class="fas fa-bolt" style="color:#81c784"></i>
                    {% elif o.company == "Boxberry" %} <i class="fas fa-box-open" style="color:#e57373"></i>
                    {% elif o.company == "Почта России" %} <i class="fas fa-envelope" style="color:#64b5f6"></i>
                    {% else %} <i class="fas fa-truck" style="color:#ffb74d"></i> {% endif %}
                </div>
                <div class="ticket-info">
                    <h3>{{ o.company }}</h3>
                    <div class="ticket-meta">
                        <span>{{ o.tariff }}</span>
                        <span><i class="far fa-clock"></i> {{ o.time }}</span>
                        {% if o.badge %}
                        <span class="badge">{{ o.badge }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="ticket-action">
                <div class="price-tag">{{ o.price }} ₽</div>
                <a href="{{ booking_links[o.company] }}"
                   target="_blank"
                   class="buy-btn"
                   onclick="return confirmGo('{{ o.company }}')">
                    Выбрать <i class="fas fa-chevron-right"></i>
                </a>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>

    <script src="/static/script.js"></script>
    <script>
        function confirmGo(company) {
            // Реальные сайты не любят iframe, поэтому открываем в новой вкладке с предупреждением
            // alert("Вы будете перенаправлены на сайт " + company + " для оформления заказа.");
            return true;
        }
    </script>
</body>
</html>